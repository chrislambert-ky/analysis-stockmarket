<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-468B94S87K"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-468B94S87K');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dollar Cost Averaging (DCA)</title>
    <style>
        /* Color Palette */
        :root {
            --blue: #003764;
            --light-blue: #5EB3E4;
            --golden-yellow: #FFC600;
            --black: #000000;
            --gray: #969595;
            --light-gray: #E0E1E1;
            --bright-green: #92D050;
            --orange: #F25C05;
            --purple: #AA2E9C;
            --red: #C00000;
            --dark-gray: #595959;
        }

        /* Base Styles */
        body, html {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #fff;
            color: #000;
            margin: 0;
            padding: 0;
        }

        /* Navigation Bar Styles */
        nav {
            background: var(--light-gray);
            padding: 1rem 0;
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            border-bottom: 2px solid var(--blue);
        }

        nav a {
            color: var(--blue);
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1rem;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            transition: background 0.2s, color 0.2s;
        }

        nav a:hover,
        nav a:focus {
            background: var(--blue);
            color: #fff;
            text-decoration: none;
        }

        /* Heading Styles */
        h1 {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 2.1rem;
            font-weight: bold;
            color: var(--blue);
            margin: 1rem 0;
            text-align: center;
        }

        h2 {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--light-blue);
            margin: 0.5rem 0;
            text-align: center;
        }

        /* Responsive Design for Navigation */
        @media (max-width: 700px) {
            nav {
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 0;
            }
            nav a {
                font-size: 1rem;
                padding: 0.5rem 1rem;
                width: 100%;
                text-align: center;
                border-radius: 0;
            }
        }

        @media (max-width: 400px) {
            nav a {
                font-size: 0.95rem;
                padding: 0.5rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <nav>
        <a href="../index.html">Home</a>
        <a href="dca.html">Dollar Cost Averaging Analysis</a>
        <a href="bod.html">Buy-on-Dip Analysis</a>
        <a href="dca-tickers.html">Dollar Cost Averaging (All Tickers)</a>
        <a href="bod-tickers.html">Buy-on-Dip (All Tickers)</a>
        <a href="dca-strat.html">Advanced Dollar Cost Averaging</a>
        <a href="bod-strat.html">Advanced Buy-on-Dip</a>
        <a href="about.html">About</a>
    </nav>
    <h1>Dollar Cost Averaging (DCA) - Cumulative Shares, Value, and Invested</h1>
    <h2>Simulating a $25/week Investment</h2>
    <h2 id="dca-summary"></h2>
    <label for="dca-ticker-select"><b>Show Ticker:</b></label>
    <select id="dca-ticker-select" style="margin-bottom:1em;">
        <option value="">-- Select Ticker --</option>
        <option value="ALL">All</option>
    </select>
    <div id="main" style="width: 100%; height: 500px;"></div>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
    // Helper function to format currency with commas
    function formatCurrency(amount) {
        return '$' + amount.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    function percentGain(value, invested) {
        if (invested === 0 || invested == null || value == null) return '';
        return ((value - invested) / invested * 100).toFixed(2) + '%';
    }
    // Fetch and parse CSV data
    async function fetchData() {
        const url = '../data/all_dca_monthly.csv';
        const response = await fetch(url + '?v=' + Date.now(), { cache: 'no-store' });
        if (!response.ok) {
            console.error('Failed to fetch CSV:', url, response.status, response.statusText);
            return [];
        }
        let text = await response.text();
        // Normalize line endings and trim
        text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        const rows = text.split('\n').filter(r => r.trim().length > 0);
        if (rows.length === 0) return [];
        const headers = rows[0].split(',').map(h => h.trim());
        const data = rows.slice(1).map(row => {
            const values = row.split(',').map(v => (v ?? '').trim());
            const obj = {};
            headers.forEach((h, i) => obj[h] = values[i] ?? '');
            return obj;
        });
        return data;
    }
    function getAllDates(data) {
        return Array.from(new Set(data.map(row => (row.Date_add || '').trim()))).sort();
    }
    // Dynamically populate dropdown with all tickers from the CSV
    async function populateDcaTickerDropdown() {
        const data = await fetchData();
        const tickers = Array.from(new Set(data.map(row => row.Symbol))).sort();
        const select = document.getElementById('dca-ticker-select');
        // Remove all except the first two options
        while (select.options.length > 2) select.remove(2);
        tickers.forEach(ticker => {
            const opt = document.createElement('option');
            opt.value = ticker;
            opt.textContent = ticker;
            select.appendChild(opt);
        });
    }
    function linearRegression(y) {
        // y: array of numbers
        const n = y.length;
        if (n === 0) return [];
        const x = Array.from({length: n}, (_, i) => i);
        const sumX = x.reduce((a, b) => a + b, 0);
        const sumY = y.reduce((a, b) => a + b, 0);
        const sumXY = x.reduce((a, b, i) => a + b * y[i], 0);
        const sumXX = x.reduce((a, b) => a + b * b, 0);
        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        return x.map(xi => slope * xi + intercept);
    }
    function prepareSeries(data, tickers, allDates, showPriceAndRegression) {
        const series = [];
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dda0dd', '#98d8c8', '#f7dc6f'];
        let colorIndex = 0;
        tickers.forEach(ticker => {
            const tickerData = data.filter(row => row.Symbol === ticker);
            const valueMap = Object.fromEntries(tickerData.map(row => [row.Date_add, parseFloat(row['Cumulative Value'])]));
            const isMultipleTickers = tickers.length > 1;
            const lineColor = isMultipleTickers ? colors[colorIndex % colors.length] : '#00aa00';
            colorIndex++;
            
            series.push({
                name: ticker + ' - Value',
                type: 'line',
                connectNulls: true,
                data: allDates.map(date => valueMap[date] ?? null),
                showSymbol: false,
                yAxisIndex: 0,
                lineStyle: { color: lineColor }
            });
            if (showPriceAndRegression) {
                // Price series
                const priceMap = Object.fromEntries(tickerData.map(row => [row.Date_add, parseFloat(row['Close'])]));
                const priceArr = allDates.map(date => priceMap[date] ?? null);
                // Linear regression on price
                const regArr = linearRegression(priceArr.map(v => (typeof v === 'number' && !isNaN(v)) ? v : 0));
                series.push({
                    name: ticker + ' - Price',
                    type: 'line',
                    connectNulls: true,
                    data: priceArr,
                    showSymbol: false,
                    yAxisIndex: 1,
                    lineStyle: { color: '#0077cc' }
                });
                series.push({
                    name: ticker + ' - Price Regression',
                    type: 'line',
                    connectNulls: true,
                    data: regArr,
                    showSymbol: false,
                    yAxisIndex: 1,
                    lineStyle: { type: 'dashed', color: '#ffaa00' }
                });
            }
        });
        return series;
    }
    async function renderChart(selectedTicker) {
        const data = await fetchData();
        const allTickers = Array.from(new Set(data.map(row => row.Symbol)));
        const tickers = (!selectedTicker || selectedTicker === 'ALL') ? allTickers : [selectedTicker];
        const allDates = getAllDates(data);
        const showPriceAndRegression = tickers.length === 1;
        const series = prepareSeries(data, tickers, allDates, showPriceAndRegression);
        // Build lookup for percent gain
        const gainLookup = {};
        data.forEach(row => {
            gainLookup[row.Symbol + '_' + row.Date_add] = {
                value: parseFloat(row['Cumulative Value']),
                invested: parseFloat(row['Cumulative Invested'])
            };
        });
        const chartDom = document.getElementById('main');
        if (echarts.getInstanceByDom(chartDom)) {
            echarts.getInstanceByDom(chartDom).dispose();
        }
        const chart = echarts.init(chartDom);
        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross' },
                formatter: function(params) {
                    let html = params[0].axisValue + '<br/>';
                    params.forEach(p => {
                        let val = (typeof p.value === 'number' && !isNaN(p.value)) ? p.value : (Array.isArray(p.value) && p.value.length > 1 && !isNaN(p.value[1]) ? p.value[1] : '');
                        if (typeof val === 'number' && p.seriesName.includes('Value') || p.seriesName.includes('Invested')) {
                            val = formatCurrency(val);
                        }
                        html += '<span style="color:' + p.color + '">●</span> ' + p.seriesName + ': ' + val + '<br/>';
                    });
                    tickers.forEach(ticker => {
                        const key = ticker + '_' + params[0].axisValue;
                        if (gainLookup[key]) {
                            html += '<b>' + ticker + ' % Gain: ' + percentGain(gainLookup[key].value, gainLookup[key].invested) + '</b><br/>';
                        }
                    });
                    return html;
                }
            },
            legend: { 
                data: series.map(s => s.name),
                selected: series.reduce((acc, s) => {
                    acc[s.name] = true; // All series visible by default
                    return acc;
                }, {}),
                type: 'scroll'
            },
            xAxis: { type: 'category', data: allDates, name: 'Date' },
            yAxis: showPriceAndRegression ? [
                { type: 'value', name: 'USD Value' },
                { type: 'value', name: 'Stock Price', position: 'right' }
            ] : [
                { type: 'value', name: 'USD Value' }
            ],
            series: series
        };
        chart.setOption(option);
        // Calculate overall percent return for each ticker (last value)
        let summaryArr = tickers.map(ticker => {
            const tickerData = data.filter(row => row.Symbol === ticker);
            if (tickerData.length > 0) {
                const last = tickerData[tickerData.length - 1];
                const value = parseFloat(last['Cumulative Value']);
                const invested = parseFloat(last['Cumulative Invested']);
                const pct = percentGain(value, invested);
                return { ticker, pct: parseFloat(pct), pctStr: pct };
            }
            return null;
        }).filter(Boolean);
        if (tickers.length > 1) {
            summaryArr.sort((a, b) => b.pct - a.pct);
        }
        let summary = summaryArr.map(s => `<b>${s.ticker}:</b> ${s.pctStr} &nbsp;`).join('');
        document.getElementById('dca-summary').innerHTML = summary;
    }
    // Dropdown event
    document.getElementById('dca-ticker-select').addEventListener('change', function() {
        const selected = this.value;
        renderChart(selected);
    });
    // Initial setup: populate dropdown, but do not render chart until user selects
    populateDcaTickerDropdown();
    renderChart('');
    </script>
</body>
</html>