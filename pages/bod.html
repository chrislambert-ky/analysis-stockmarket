<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-468B94S87K"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-468B94S87K');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy on Dip (BOD) Analysis</title>
    <style>
        /* Color Palette */
        :root {
            --blue: #003764;
            --light-blue: #5EB3E4;
            --golden-yellow: #FFC600;
            --black: #000000;
            --gray: #969595;
            --light-gray: #E0E1E1;
            --bright-green: #92D050;
            --orange: #F25C05;
            --purple: #AA2E9C;
            --red: #C00000;
            --dark-gray: #595959;
        }

        /* Base Styles */
        body, html {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #fff;
            color: #000;
            margin: 0;
            padding: 0;
        }

        /* Navigation Bar Styles */
        nav {
            background: var(--light-gray);
            padding: 1rem 0;
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            border-bottom: 2px solid var(--blue);
        }

        nav a {
            color: var(--blue);
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1rem;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            transition: background 0.2s, color 0.2s;
        }

        nav a:hover,
        nav a:focus {
            background: var(--blue);
            color: #fff;
            text-decoration: none;
        }

        /* Heading Styles */
        h1 {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 2.1rem;
            font-weight: bold;
            color: var(--blue);
            margin: 1rem 0;
            text-align: center;
        }

        h2 {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--light-blue);
            margin: 0.5rem 0;
            text-align: center;
        }

        /* Button Styles */
        #calculate-btn {
            transition: all 0.3s ease;
        }
        
        #calculate-btn:hover:not(:disabled) {
            background-color: #7dd35e !important;
            transform: translateY(-1px);
        }

        #calculate-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            background-color: var(--gray) !important;
        }

        /* Responsive Design for Navigation */
        @media (max-width: 700px) {
            nav {
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 0;
            }
            nav a {
                font-size: 1rem;
                padding: 0.5rem 1rem;
                width: 100%;
                text-align: center;
                border-radius: 0;
            }
        }

        @media (max-width: 400px) {
            nav a {
                font-size: 0.95rem;
                padding: 0.5rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <nav>
        <a href="../index.html">Home</a>
        <a href="dca.html">Dollar Cost Averaging Analysis</a>
        <a href="bod.html">Buy-on-Dip Analysis</a>
        <a href="dca-tickers.html">Dollar Cost Averaging (All Tickers)</a>
        <a href="bod-tickers.html">Buy-on-Dip (All Tickers)</a>
        <a href="dca-strat.html">Advanced Dollar Cost Averaging</a>
        <a href="bod-strat.html">Advanced Buy-on-Dip</a>
        <a href="about.html">About</a>
    </nav>
    <h1>Buy-on-Dip Strategy - Cumulative Shares, Value, and Invested</h1>
    <h2>Simulating limit orders of 1 share for each percent drop (1-5%), purchased at average daily price</h2>
    <h2 id="bod-summary"></h2>
    <label for="bod-ticker-select"><b>Show Ticker:</b></label>
    <select id="bod-ticker-select" style="margin-bottom:1em;">
        <option value="">-- Select Ticker --</option>
        <option value="ALL">All</option>
    </select>
    
    <button id="calculate-btn" style="margin-left: 10px; padding: 8px 16px; background-color: var(--bright-green); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
        Calculate BOD Strategy
    </button>
    
    <!-- Loading indicator -->
    <div id="loading-container" style="display: none; text-align: center; margin: 20px 0;">
        <div style="color: var(--blue); font-weight: bold; margin-bottom: 10px;">Calculating Buy-on-Dip Strategy...</div>
        <div id="progress-bar" style="width: 300px; height: 20px; background-color: #f0f0f0; border-radius: 10px; margin: 0 auto; overflow: hidden;">
            <div id="progress-fill" style="height: 100%; background-color: var(--bright-green); width: 0%; transition: width 0.3s ease; border-radius: 10px;"></div>
        </div>
        <div id="progress-text" style="color: var(--gray); font-size: 0.9em; margin-top: 5px;">Preparing calculation...</div>
    </div>
    
    <!-- Detailed Metrics Section -->
    <div id="detailed-metrics" style="display: none; margin: 20px auto; max-width: 1000px; background-color: #f0f8ff; padding: 20px; border-radius: 8px;">
        <h3 style="text-align: center; color: var(--blue); margin-bottom: 20px;">Detailed Investment Metrics</h3>
        <div id="metrics-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;"></div>
    </div>
    
    <div id="main" style="width: 100%; height: 500px;"></div>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
    // Loading indicator functions
    function showLoading() {
        document.getElementById('loading-container').style.display = 'block';
        document.getElementById('detailed-metrics').style.display = 'none';
        document.getElementById('calculate-btn').disabled = true;
        document.getElementById('calculate-btn').textContent = 'Calculating...';
        updateProgress(0, 'Fetching historical data...');
    }
    
    function hideLoading() {
        document.getElementById('loading-container').style.display = 'none';
        document.getElementById('calculate-btn').disabled = false;
        document.getElementById('calculate-btn').textContent = 'Calculate BOD Strategy';
    }
    
    function updateProgress(percent, text) {
        document.getElementById('progress-fill').style.width = percent + '%';
        document.getElementById('progress-text').textContent = text;
    }
    
    // Helper function to format currency with commas
    function formatCurrency(amount) {
        return '$' + amount.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    function percentGain(value, invested) {
        if (invested === 0 || invested == null || value == null) return '';
        return ((value - invested) / invested * 100).toFixed(2) + '%';
    }
    
    // Calculate detailed metrics for selected ticker(s)
    function calculateDetailedMetrics(data, tickers) {
        const metrics = [];
        
        tickers.forEach(ticker => {
            const tickerData = data.filter(row => row.Symbol === ticker);
            
            if (tickerData.length === 0) return;
            
            // Count total weeks (assuming data is daily, so approximate weeks)
            const totalWeeks = Math.round(tickerData.length / 5); // Approximate trading weeks
            
            // Get final values from last row
            const lastRow = tickerData[tickerData.length - 1];
            const totalShares = parseFloat(lastRow['Cumulative Shares']);
            const totalInvested = parseFloat(lastRow['Cumulative Invested']);
            const totalValue = parseFloat(lastRow['Cumulative Value']);
            
            // Calculate total dips/purchases - this should equal total shares since we buy 1 share per dip
            const totalDipsPurchases = totalShares; // Each share represents one dip purchase
            
            const gainAmount = totalValue - totalInvested;
            const gainPercent = totalInvested > 0 ? ((totalValue - totalInvested) / totalInvested * 100).toFixed(2) : '0.00';
            
            metrics.push({
                ticker: ticker,
                totalWeeks: totalWeeks,
                totalDipsPurchases: totalDipsPurchases,
                totalShares: totalShares,
                totalInvested: totalInvested,
                totalValue: totalValue,
                gainAmount: gainAmount,
                gainPercent: gainPercent
            });
        });
        
        return metrics;
    }
    
    // Display detailed metrics
    function displayDetailedMetrics(metrics) {
        const container = document.getElementById('metrics-container');
        container.innerHTML = '';
        
        if (metrics.length === 0) {
            document.getElementById('detailed-metrics').style.display = 'none';
            return;
        }
        
        metrics.forEach(metric => {
            const metricDiv = document.createElement('div');
            metricDiv.style.cssText = `
                background: white;
                padding: 15px;
                border-radius: 8px;
                border: 1px solid #ddd;
                margin-bottom: 15px;
            `;
            
            const gainColor = metric.gainAmount >= 0 ? '#28a745' : '#dc3545';
            
            metricDiv.innerHTML = `
                <h4 style="margin: 0 0 10px 0; color: var(--blue); font-size: 1.2rem; text-align: center;">${metric.ticker}</h4>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; text-align: center;">
                    <div style="padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--blue);">${metric.totalWeeks}</div>
                        <div style="font-size: 0.9em; color: #666;">Total Weeks</div>
                    </div>
                    <div style="padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--blue);">${metric.totalDipsPurchases}</div>
                        <div style="font-size: 0.9em; color: #666;">Total Dips/Purchases</div>
                    </div>
                    <div style="padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--blue);">${formatCurrency(metric.totalInvested)}</div>
                        <div style="font-size: 0.9em; color: #666;">Total Invested</div>
                    </div>
                    <div style="padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--blue);">${formatCurrency(metric.totalValue)}</div>
                        <div style="font-size: 0.9em; color: #666;">Total Value</div>
                    </div>
                    <div style="padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 1.5em; font-weight: bold; color: ${gainColor};">${formatCurrency(metric.gainAmount)} (${metric.gainPercent}%)</div>
                        <div style="font-size: 0.9em; color: #666;">Gain/Loss</div>
                    </div>
                </div>
            `;
            
            container.appendChild(metricDiv);
        });
        
        document.getElementById('detailed-metrics').style.display = 'block';
    }
    
    // Fetch and parse historical ticker data
    async function fetchHistoricalData() {
        const response = await fetch('../data/history_tickers.csv');
        const text = await response.text();
        const rows = text.split('\n').filter(Boolean);
        const headers = rows[0].split(',');
        const data = rows.slice(1).map(row => {
            const values = row.split(',');
            const obj = {};
            headers.forEach((h, i) => obj[h.trim()] = values[i]);
            return obj;
        });
        return data;
    }
    
    // Calculate Buy-on-Dip strategy for a specific ticker
    function calculateBuyOnDip(historicalData, ticker, startDate = '2015-09-01', endDate = '2025-09-01') {
        const tickerData = historicalData
            .filter(row => row.Symbol === ticker && row.Date >= startDate && row.Date <= endDate)
            .sort((a, b) => new Date(a.Date) - new Date(b.Date));
        
        const results = [];
        let cumulativeShares = 0;
        let cumulativeInvested = 0;
        
        for (let i = 1; i < tickerData.length; i++) {
            const today = tickerData[i];
            const yesterday = tickerData[i - 1];
            
            const todayLow = parseFloat(today.Low);
            const todayClose = parseFloat(today.Close);
            const yesterdayClose = parseFloat(yesterday.Close);
            
            // Check for dips at 1%, 2%, 3%, 4%, 5% levels
            // We set limit orders at previous close * (1 - dip_percentage)
            for (let dipLevel = 1; dipLevel <= 5; dipLevel++) {
                const limitOrderPrice = yesterdayClose * (1 - dipLevel / 100);
                
                // Check if today's low reached our limit order price
                if (todayLow <= limitOrderPrice) {
                    // Buy 1 share at the exact limit order price
                    const buyPrice = limitOrderPrice;
                    cumulativeShares += 1;
                    cumulativeInvested += buyPrice;
                    
                    const cumulativeValue = cumulativeShares * todayClose;
                    
                    results.push({
                        Date_add: today.Date,
                        Weekday: new Date(today.Date).toLocaleDateString('en-US', { weekday: 'long' }),
                        Symbol: ticker,
                        Strategy: 'Buy_on_Dip',
                        Buy_Price: buyPrice.toFixed(2),
                        Buy_Level: dipLevel + '%',
                        'Shares Purchased': 1,
                        'Dollars Invested': buyPrice.toFixed(2),
                        'Cumulative Shares': cumulativeShares,
                        'Cumulative Invested': cumulativeInvested.toFixed(2),
                        'Cumulative Value': cumulativeValue.toFixed(2),
                        Close: todayClose.toFixed(2),
                        Previous_Close: yesterdayClose.toFixed(2)
                    });
                }
            }
        }
        
        return results;
    }
    
    // Dynamically populate dropdown with all tickers from historical data
    async function populateBodTickerDropdown() {
        const historicalData = await fetchHistoricalData();
        const tickers = Array.from(new Set(historicalData.map(row => row.Symbol))).sort();
        const select = document.getElementById('bod-ticker-select');
        // Remove all except the first two options
        while (select.options.length > 2) select.remove(2);
        tickers.forEach(ticker => {
            const opt = document.createElement('option');
            opt.value = ticker;
            opt.textContent = ticker;
            select.appendChild(opt);
        });
    }
    function prepareSeries(data, tickers, allDates) {
        const series = [];
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dda0dd', '#98d8c8', '#f7dc6f'];
        let colorIndex = 0;
        tickers.forEach(ticker => {
            const tickerData = data.filter(row => row.Symbol === ticker);
            
            // Debug: log ticker data
            console.log(`Ticker ${ticker}: ${tickerData.length} data points`);
            if (tickerData.length > 0) {
                const lastRow = tickerData[tickerData.length - 1];
                console.log(`${ticker} final value: ${lastRow['Cumulative Value']}, invested: ${lastRow['Cumulative Invested']}`);
            }
            
            const valueMap = Object.fromEntries(tickerData.map(row => [row.Date_add, parseFloat(row['Cumulative Value'])]));
            const isMultipleTickers = tickers.length > 1;
            const valueColor = isMultipleTickers ? colors[colorIndex % colors.length] : '#00aa00';
            colorIndex++;
            
            const valueData = allDates.map(date => valueMap[date] ?? null);
            
            series.push({
                name: ticker + ' - Value',
                type: 'line',
                connectNulls: true,
                data: valueData,
                showSymbol: false,
                lineStyle: { color: valueColor }
            });
            
            // Only show invested line for individual tickers
            if (!isMultipleTickers) {
                const investedMap = Object.fromEntries(tickerData.map(row => [row.Date_add, parseFloat(row['Cumulative Invested'])]));
                series.push({
                    name: ticker + ' - Invested',
                    type: 'line',
                    connectNulls: true,
                    data: allDates.map(date => investedMap[date] ?? null),
                    showSymbol: false,
                    lineStyle: { type: 'dashed', color: '#0077cc' }
                });
            }
        });
        return series;
    }
    async function renderChart(selectedTicker) {
        if (!selectedTicker || selectedTicker === '') {
            // No ticker selected - clear chart and show instruction
            const chartDom = document.getElementById('main');
            if (echarts.getInstanceByDom(chartDom)) {
                echarts.getInstanceByDom(chartDom).dispose();
            }
            document.getElementById('detailed-metrics').style.display = 'none';
            document.getElementById('bod-summary').innerHTML = 'Please select a ticker and click Calculate to begin analysis.';
            return;
        }
        
        showLoading();
        
        try {
            updateProgress(20, 'Loading historical data...');
            const historicalData = await fetchHistoricalData();
            
            updateProgress(40, 'Processing ticker data...');
            const allTickers = Array.from(new Set(historicalData.map(row => row.Symbol)));
            const tickers = (!selectedTicker || selectedTicker === 'ALL') ? allTickers : [selectedTicker];
            
            updateProgress(60, 'Calculating buy-on-dip strategies...');
            // Calculate buy-on-dip data for selected tickers
            const allBodData = [];
            const allDates = new Set();
            
            let processed = 0;
            for (const ticker of tickers) {
                const bodData = calculateBuyOnDip(historicalData, ticker);
                allBodData.push(...bodData);
                bodData.forEach(row => allDates.add(row.Date_add));
                processed++;
                const progress = 60 + (processed / tickers.length) * 25;
                updateProgress(progress, `Processing ${ticker}... (${processed}/${tickers.length})`);
                
                // Add small delay to show progress
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            updateProgress(90, 'Preparing chart...');
            const sortedDates = Array.from(allDates).sort();
            const series = prepareSeries(allBodData, tickers, sortedDates);
            
            // Build lookup for percent gain
            const gainLookup = {};
            allBodData.forEach(row => {
                gainLookup[row.Symbol + '_' + row.Date_add] = {
                    value: parseFloat(row['Cumulative Value']),
                    invested: parseFloat(row['Cumulative Invested'])
                };
            });
            
            updateProgress(95, 'Rendering chart...');
            const chartDom = document.getElementById('main');
            if (echarts.getInstanceByDom(chartDom)) {
                echarts.getInstanceByDom(chartDom).dispose();
            }
            const chart = echarts.init(chartDom);
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    formatter: function(params) {
                        let html = params[0].axisValue + '<br/>';
                        params.forEach(p => {
                            let val = (typeof p.value === 'number' && !isNaN(p.value)) ? p.value : (Array.isArray(p.value) && p.value.length > 1 && !isNaN(p.value[1]) ? p.value[1] : '');
                            if (typeof val === 'number' && (p.seriesName.includes('Value') || p.seriesName.includes('Invested'))) {
                                val = formatCurrency(val);
                            }
                            html += '<span style="color:' + p.color + '">●</span> ' + p.seriesName + ': ' + val + '<br/>';
                        });
                        tickers.forEach(ticker => {
                            const key = ticker + '_' + params[0].axisValue;
                            if (gainLookup[key]) {
                                html += '<b>' + ticker + ' % Gain: ' + percentGain(gainLookup[key].value, gainLookup[key].invested) + '</b><br/>';
                            }
                        });
                        return html;
                    }
                },
            legend: { 
                data: series.map(s => s.name),
                selected: series.reduce((acc, s) => {
                    acc[s.name] = true; // All series visible by default
                    return acc;
                }, {}),
                type: 'scroll'
            },
            xAxis: { type: 'category', data: sortedDates, name: 'Date' },
            yAxis: { type: 'value', name: 'USD' },
            series: series
        };
        chart.setOption(option);
        
        // Calculate overall percent return for each ticker (last value)
        let summaryArr = tickers.map(ticker => {
            const tickerData = allBodData.filter(row => row.Symbol === ticker);
            if (tickerData.length > 0) {
                const last = tickerData[tickerData.length - 1];
                const value = parseFloat(last['Cumulative Value']);
                const invested = parseFloat(last['Cumulative Invested']);
                const pct = percentGain(value, invested);
                return { ticker, pct: parseFloat(pct), pctStr: pct };
            }
            return null;
        }).filter(Boolean);
        
        if (tickers.length > 1) {
            summaryArr.sort((a, b) => b.pct - a.pct);
        }
        let summary = summaryArr.map(s => `<b>${s.ticker}:</b> ${s.pctStr} &nbsp;`).join('');
        document.getElementById('bod-summary').innerHTML = summary;
        
        // Calculate and display detailed metrics
        if (selectedTicker && selectedTicker !== 'ALL' && selectedTicker !== '') {
            // Single ticker selected - show detailed metrics
            const detailedMetrics = calculateDetailedMetrics(allBodData, [selectedTicker]);
            displayDetailedMetrics(detailedMetrics);
        } else {
            // All tickers selected or no ticker selected - hide metrics
            document.getElementById('detailed-metrics').style.display = 'none';
        }
        
        } catch (error) {
            console.error('Error during calculation:', error);
            document.getElementById('bod-summary').innerHTML = '<span style="color: red;">Error calculating BOD strategy. Please try again.</span>';
        } finally {
            hideLoading();
        }
    }

    // Calculate button event listener
    document.getElementById('calculate-btn').addEventListener('click', function() {
        const selectedTicker = document.getElementById('bod-ticker-select').value;
        renderChart(selectedTicker);
    });
    
    // Dropdown event - just update message, never draw chart
    document.getElementById('bod-ticker-select').addEventListener('change', function() {
        const selected = this.value;
        // Always clear any existing chart when dropdown changes
        const chartDom = document.getElementById('main');
        if (echarts.getInstanceByDom(chartDom)) {
            echarts.getInstanceByDom(chartDom).dispose();
        }
        document.getElementById('detailed-metrics').style.display = 'none';
        
        if (!selected || selected === '') {
            document.getElementById('bod-summary').innerHTML = 'Please select a ticker and click Calculate to begin analysis.';
        } else {
            document.getElementById('bod-summary').innerHTML = 'Click Calculate to analyze ' + (selected === 'ALL' ? 'all tickers' : selected) + '.';
        }
    });
    
    // Initial setup: populate dropdown, show initial message
    populateBodTickerDropdown();
    document.getElementById('bod-summary').innerHTML = 'Please select a ticker and click Calculate to begin analysis.';
    </script>
</body>
</html>