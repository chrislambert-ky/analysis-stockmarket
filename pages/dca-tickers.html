<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-468B94S87K"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-468B94S87K');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dollar Cost Averaging - All Tickers</title>
    <style>
        /* Color Palette */
        :root {
            --blue: #003764;
            --light-blue: #5EB3E4;
            --golden-yellow: #FFC600;
            --black: #000000;
            --gray: #969595;
            --light-gray: #E0E1E1;
            --bright-green: #92D050;
            --orange: #F25C05;
            --purple: #AA2E9C;
            --red: #C00000;
            --dark-gray: #595959;
        }

        /* Base Styles */
        body, html {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #fff;
            color: #000;
            margin: 0;
            padding: 0;
        }

        /* Navigation Bar Styles */
        nav {
            background: var(--light-gray);
            padding: 1rem 0;
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            border-bottom: 2px solid var(--blue);
        }

        nav a {
            color: var(--blue);
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1rem;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            transition: background 0.2s, color 0.2s;
        }

        nav a:hover,
        nav a:focus {
            background: var(--blue);
            color: #fff;
            text-decoration: none;
        }

        /* Chart Styles */
        .chart-container {
            margin-bottom: 2em;
            border: 1px solid #eee;
            padding: 1em;
            border-radius: 8px;
            background: #fafafa;
        }
        .chart-title {
            font-size: 1.2em;
            margin-bottom: 0.5em;
        }
        .ticker-label {
            font-size: 0.9em;
            color: #555;
            margin-left: 0.5em;
        }

        /* Period button styles (match BOD page) */
        #download-analysis-btn, #calculate-btn, .period-btn {
            transition: all 0.3s ease;
        }

        .period-selection {
            text-align: center;
            margin: 20px 0;
        }

        .period-btn {
            padding: 10px 20px;
            margin: 0 5px;
            background-color: var(--bright-green);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95em;
        }

        .period-btn:hover:not(:disabled) {
            background-color: #7dd35e !important;
            transform: translateY(-1px);
        }

        .period-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            background-color: var(--gray) !important;
        }

        .period-btn.active {
            background-color: var(--orange) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .period-btn.active:hover {
            background-color: var(--orange) !important;
            transform: none !important;
        }

        /* Loading Progress Styles */
        .loading-container {
            text-align: center;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 80%;
            max-width: 500px;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 10px auto;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--light-blue), var(--blue));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            font-size: 14px;
            color: var(--blue);
            margin-top: 5px;
            font-weight: bold;
        }

        /* Heading Styles */
        h1 {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 2.1rem;
            font-weight: bold;
            color: var(--blue);
            margin: 1rem 0;
            text-align: center;
        }

        h2 {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--light-blue);
            margin: 0.5rem 0;
            text-align: center;
        }

        /* Responsive Design for Navigation */
        @media (max-width: 700px) {
            nav {
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 0;
            }
            nav a {
                font-size: 1rem;
                padding: 0.5rem 1rem;
                width: 100%;
                text-align: center;
                border-radius: 0;
            }
        }

        @media (max-width: 400px) {
            nav a {
                font-size: 0.95rem;
                padding: 0.5rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <nav>
        <a href="../index.html">Home</a>
        <a href="dca.html">Dollar Cost Averaging Analysis</a>
        <a href="bod.html">Buy-on-Dip Analysis</a>
        <a href="dca-tickers.html">Dollar Cost Averaging (All Tickers)</a>
        <a href="bod-tickers.html">Buy-on-Dip (All Tickers)</a>
        <a href="dca-strat.html">Advanced Dollar Cost Averaging</a>
        <a href="bod-strat.html">Advanced Buy-on-Dip</a>
        <a href="about.html">About</a>
    </nav>
    <h1>Dollar Cost Averaging Strategy - Per Ticker</h1>
    <h2>Investing $25/week (first trading day of each week at average daily price) across all available tickers</h2>
    
    <!-- Period Selection -->
    <div class="period-selection">
        <button id="ytd-btn" class="period-btn active">YTD</button>
        <button id="5y-btn" class="period-btn">5 Years</button>
        <button id="10y-btn" class="period-btn">10 Years</button>
        <button id="15y-btn" class="period-btn">15 Years</button>
        <button id="20y-btn" class="period-btn">20 Years</button>
    </div>

    <!-- Loading Progress -->
    <div id="loading" class="loading-container">
        <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
        </div>
        <div id="progress-text" class="progress-text">Loading...</div>
    </div>
    
    <div id="charts-root"></div>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
    // Helper function to format currency with commas
    function formatCurrency(amount) {
        return '$' + amount.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    function percentGain(value, invested) {
        if (invested === 0 || invested == null || value == null) return '';
        return ((value - invested) / invested * 100).toFixed(2) + '%';
    }

    // Loading progress functions
    function showLoading() {
        document.getElementById('loading').style.display = 'block';
        updateProgress(0, 'Starting...');
    }

    function hideLoading() {
        document.getElementById('loading').style.display = 'none';
    }

    function updateProgress(percent, message) {
        document.getElementById('progress-fill').style.width = percent + '%';
        document.getElementById('progress-text').textContent = message;
    }
    // Fetch and parse CSV data
    async function fetchData() {
        const url = '../data/history_tickers.csv';
        const response = await fetch(url + '?v=' + Date.now(), { cache: 'no-store' });
        if (!response.ok) {
            console.error('Failed to fetch CSV:', url, response.status, response.statusText);
            return [];
        }
        let text = await response.text();
        // Normalize line endings and trim
        text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        const rows = text.split('\n').filter(r => r.trim().length > 0);
        if (rows.length === 0) return [];
        const headers = rows[0].split(',').map(h => h.trim());
        const data = rows.slice(1).map(row => {
            const values = row.split(',').map(v => (v ?? '').trim());
            const obj = {};
            headers.forEach((h, i) => obj[h] = values[i] ?? '');
            return obj;
        });
        return data;
    }

    // Calculate weekly DCA strategy for a specific ticker
    function calculateWeeklyDCA(tickerData, yearsBack = 'YTD') {
        const endDate = new Date();
        let startDate;
        
        if (yearsBack === 'YTD') {
            // Year to date - start from January 1st of current year
            startDate = new Date(endDate.getFullYear(), 0, 1);
        } else {
            // Calculate years back from current date
            startDate = new Date();
            startDate.setFullYear(endDate.getFullYear() - yearsBack);
        }
        
        // Filter data by date range
        const filteredData = tickerData
            .filter(row => {
                const rowDate = new Date(row.Date_add);
                return rowDate >= startDate && rowDate <= endDate;
            })
            .sort((a, b) => new Date(a.Date_add) - new Date(b.Date_add));
        
        if (filteredData.length === 0) {
            return [];
        }
        
        let cumulativeShares = 0;
        let cumulativeInvested = 0;
        const weeklyInvestment = 25;
        const results = [];
        
        // Generate weekly target dates (Mondays)
        let currentDate = new Date(startDate);
        // Find first Monday on or after start date
        while (currentDate.getDay() !== 1) { // 1 = Monday
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        while (currentDate <= endDate) {
            const targetDateStr = currentDate.toISOString().split('T')[0];
            
            // Find closest trading day to this Monday
            const closestTradingDay = findClosestTradingDay(filteredData, targetDateStr);
            
            if (closestTradingDay) {
                const avgDailyPrice = parseFloat(closestTradingDay.avg_daily_price);
                const closingPrice = parseFloat(closestTradingDay.Close);
                const sharesThisWeek = weeklyInvestment / avgDailyPrice;
                
                cumulativeShares += sharesThisWeek;
                cumulativeInvested += weeklyInvestment;
                
                results.push({
                    date: closestTradingDay.Date_add,
                    weekday: closestTradingDay.Weekday,
                    close: closingPrice,
                    avgDailyPrice: avgDailyPrice,
                    sharesThisWeek: sharesThisWeek,
                    investedThisWeek: weeklyInvestment,
                    cumulativeShares: cumulativeShares,
                    cumulativeInvested: cumulativeInvested,
                    cumulativeValue: cumulativeShares * closingPrice
                });
            }
            
            // Move to next Monday
            currentDate.setDate(currentDate.getDate() + 7);
        }

        return results;
    }
    
    // Helper function to find closest trading day to a target date
    function findClosestTradingDay(tickerData, targetDate) {
        const target = new Date(targetDate);
        let closest = null;
        let minDiff = Infinity;
        
        for (const row of tickerData) {
            const rowDate = new Date(row.Date_add);
            const diff = Math.abs(rowDate - target);
            if (diff < minDiff) {
                minDiff = diff;
                closest = row;
            }
        }
        
        return closest;
    }

    // Global variable to track current period
    let currentSelectedPeriod = 'YTD';

    function getAllDates(processedData) {
        const allDates = new Set();
        Object.values(processedData).forEach(tickerResults => {
            tickerResults.forEach(result => allDates.add(result.date));
        });
        return Array.from(allDates).sort();
    }

    function prepareSeries(processedData, ticker, allDates) {
        const tickerResults = processedData[ticker] || [];
        const valueMap = Object.fromEntries(tickerResults.map(result => [result.date, result.cumulativeValue]));
        const investedMap = Object.fromEntries(tickerResults.map(result => [result.date, result.cumulativeInvested]));
        
        return [
            {
                name: ticker + ' - Value',
                type: 'line',
                connectNulls: true,
                data: allDates.map(date => valueMap[date] ?? null),
                showSymbol: false,
                lineStyle: { color: '#00aa00', width: 2 }
            },
            {
                name: 'Invested',
                type: 'line',
                connectNulls: true,
                data: allDates.map(date => investedMap[date] ?? null),
                showSymbol: false,
                lineStyle: { color: '#ff4444', type: 'dashed', width: 2 }
            }
        ];
    }

    async function renderAllCharts(period = 'YTD') {
        showLoading();
        
        try {
            updateProgress(10, 'Loading historical data...');
            const rawData = await fetchData();
            console.log('Historical data loaded:', rawData.length, 'rows');
            
            updateProgress(25, 'Processing ticker data...');
            // Group data by ticker
            const tickerGroups = {};
            rawData.forEach(row => {
                const ticker = row.Symbol;
                if (!tickerGroups[ticker]) {
                    tickerGroups[ticker] = [];
                }
                tickerGroups[ticker].push(row);
            });

            // Convert period to yearsBack parameter
            const yearsBack = period === 'YTD' ? 'YTD' : parseInt(period.replace('Y', ''));

            updateProgress(40, 'Calculating DCA strategies...');
            // Calculate DCA results for each ticker
            const processedData = {};
            const allTickers = Object.keys(tickerGroups);
            let processed = 0;
            
            for (const ticker of allTickers) {
                processedData[ticker] = calculateWeeklyDCA(tickerGroups[ticker], yearsBack);
                processed++;
                const progress = 40 + (processed / allTickers.length) * 30;
                updateProgress(progress, `Processing ${ticker}... (${processed}/${allTickers.length})`);
                
                // Add small delay to show progress
                await new Promise(resolve => setTimeout(resolve, 20));
            }
            
            updateProgress(75, 'Sorting tickers by performance...');
            // Get tickers with data and sort by performance
            let tickers = Object.keys(processedData).filter(ticker => processedData[ticker].length > 0);
            console.log('Tickers with DCA data:', tickers);
            
            // Sort tickers by percent return (descending)
            tickers = tickers.map(ticker => {
                const tickerResults = processedData[ticker];
                let pct = -Infinity;
                if (tickerResults.length > 0) {
                    const last = tickerResults[tickerResults.length - 1];
                    const value = last.cumulativeValue;
                    const invested = last.cumulativeInvested;
                    pct = invested ? ((value - invested) / invested * 100) : -Infinity;
                }
                return { ticker, pct };
            }).sort((a, b) => b.pct - a.pct).map(obj => obj.ticker);

            updateProgress(80, 'Rendering charts...');
            const allDates = getAllDates(processedData);
            const root = document.getElementById('charts-root');
            root.innerHTML = '';

            let chartsRendered = 0;
            for (const ticker of tickers) {
                const tickerResults = processedData[ticker];
                
                // Create container
                const container = document.createElement('div');
                container.className = 'chart-container';
                
                // Calculate overall metrics for this ticker
                let summary = '';
                let weeksCount = 0;
                let totalInvested = 0;
                let totalValue = 0;
                let totalShares = 0;
                
                if (tickerResults.length > 0) {
                    const last = tickerResults[tickerResults.length - 1];
                    weeksCount = tickerResults.length;
                    totalInvested = last.cumulativeInvested;
                    totalValue = last.cumulativeValue;
                    totalShares = last.cumulativeShares;
                    const pct = percentGain(totalValue, totalInvested);
                    summary = `<span style="color:#007700;font-size:1rem;">${ticker} Overall % Gain: <b>${pct}</b> | Weeks: ${weeksCount} | Shares: ${totalShares.toFixed(4)} | Invested: ${formatCurrency(totalInvested)} | Value: ${formatCurrency(totalValue)}</span>`;
                }
                
                // Title
                const title = document.createElement('div');
                title.className = 'chart-title';
                title.innerHTML = `Ticker: <span id="ticker-symbol">${ticker}</span> <span class="ticker-label">Growth of $25/week (first available trading day)</span><br/>${summary}`;
                container.appendChild(title);
                
                // Chart div
                const chartDiv = document.createElement('div');
                chartDiv.style.width = '100%';
                chartDiv.style.height = '400px';
                container.appendChild(chartDiv);
                root.appendChild(container);

                // Prepare series
                const series = prepareSeries(processedData, ticker, allDates);
                
                // Build lookup for percent gain
                const gainLookup = {};
                tickerResults.forEach(result => {
                    gainLookup[result.date] = {
                        value: result.cumulativeValue,
                        invested: result.cumulativeInvested
                    };
                });

                // Render chart
                const chart = echarts.init(chartDiv);
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'cross' },
                        formatter: function(params) {
                            let html = params[0].axisValue + '<br/>';
                            params.forEach(p => {
                                let val = (typeof p.value === 'number' && !isNaN(p.value)) ? p.value : (Array.isArray(p.value) && p.value.length > 1 && !isNaN(p.value[1]) ? p.value[1] : '');
                                if (typeof val === 'number' && (p.seriesName.includes('Value') || p.seriesName.includes('Invested'))) {
                                    val = formatCurrency(val);
                                }
                                html += '<span style="color:' + p.color + '">●</span> ' + p.seriesName + ': ' + val + '<br/>';
                            });
                            const key = params[0].axisValue;
                            if (gainLookup[key]) {
                                html += '<b>% Gain: ' + percentGain(gainLookup[key].value, gainLookup[key].invested) + '</b><br/>';
                            }
                            return html;
                        }
                    },
                    legend: { data: series.map(s => s.name) },
                    xAxis: { type: 'category', data: allDates, name: 'Date' },
                    yAxis: { type: 'value', name: 'USD' },
                    series: series
                };
                chart.setOption(option);
                
                // Update progress for chart rendering
                chartsRendered++;
                const chartProgress = 80 + (chartsRendered / tickers.length) * 15;
                updateProgress(chartProgress, `Rendering charts... (${chartsRendered}/${tickers.length})`);
                
                // Add small delay to show progress
                await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            updateProgress(100, 'Complete!');
            
            // Hide loading after a brief delay
            setTimeout(() => {
                hideLoading();
            }, 500);
            
        } catch (error) {
            console.error('Error rendering charts:', error);
            document.getElementById('charts-root').innerHTML = '<p>Error loading data: ' + error.message + '</p>';
            hideLoading();
        }
    }

    // Function to update period button states
    function updatePeriodButtonStates(activeButtonId) {
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(activeButtonId).classList.add('active');
    }

    // Period button event listeners
    document.getElementById('ytd-btn').addEventListener('click', function() {
        currentSelectedPeriod = 'YTD';
        updatePeriodButtonStates('ytd-btn');
        renderAllCharts(currentSelectedPeriod);
    });

    document.getElementById('5y-btn').addEventListener('click', function() {
        currentSelectedPeriod = '5Y';
        updatePeriodButtonStates('5y-btn');
        renderAllCharts(currentSelectedPeriod);
    });

    document.getElementById('10y-btn').addEventListener('click', function() {
        currentSelectedPeriod = '10Y';
        updatePeriodButtonStates('10y-btn');
        renderAllCharts(currentSelectedPeriod);
    });

    document.getElementById('15y-btn').addEventListener('click', function() {
        currentSelectedPeriod = '15Y';
        updatePeriodButtonStates('15y-btn');
        renderAllCharts(currentSelectedPeriod);
    });

    document.getElementById('20y-btn').addEventListener('click', function() {
        currentSelectedPeriod = '20Y';
        updatePeriodButtonStates('20y-btn');
        renderAllCharts(currentSelectedPeriod);
    });

    // Initialize with YTD
    renderAllCharts('YTD');
    </script>
</body>
</html>